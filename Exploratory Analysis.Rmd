---
title: "Exploratory Analysis"
author: "Richard G. Gardiner"
date: "2/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(tidyverse)
library(tidytext)
library(readxl)
library(statebins)

theme_set(theme_light())
```

```{r}
gavel <- read_excel("Gavel to Gavel dataset.xlsx") %>%
  filter(Year > 2007,
         Year < 2020)
```


# Gavel to Gavel dataset

How many bills are in my dataset?
```{r}
gavel %>%
  count()
```

How man bills over time?
```{r}
gavel %>%
  count(Year) %>%
  ggplot(aes(x = Year, y = n)) +
  geom_line() +
  labs(y = "Total Number of Bills") +
  scale_x_discrete(limits = c(2008, 2010, 2012, 2014, 2016))

# ggsave("Bills over year.jpeg")
```

```{r}
gavel %>%
  count(Year, State) %>%
  spread(Year, n) %>%
  mutate(diff = (`2009` - `2008`)) %>%
  # arrange(desc(diff))
  summarize(median_diff = median(diff, na.rm = TRUE),
            mean_diff = mean(diff, na.rm = TRUE))
  
  

```

Bills by Type
```{r}
gavel %>%
  count(Type) %>%
  filter(Type != "No Legislation") %>%
  mutate(Type = fct_reorder(Type, n)) %>%
  ggplot(aes(x = Type, y = n)) +
  geom_col() +
  labs(x = "", y = "Number of Bills") +
  coord_flip() 

# ggsave("Number of Bills by Type.jpeg")
```


Map of # of bills by state
```{r}
library(usmap)
library(maps)


all_states <- map_data("state")

us.cities %>%
  filter(capital == 2) %>%
  left_join(gavel, by = c("country.etc" = "State")) %>%
  filter(!(country.etc %in% c("AK", "HI"))) %>%
  count(long, lat, Elected) %>%
  ggplot() +
  geom_point(aes(x = long, y = lat, size = n, color = Elected)) +
  borders("state") +
  theme_light() +
  xlab("") +
  ylab("") +
  theme_void() +
  labs(caption = "Larger Circles Indicate More Bills",
       color = "Selection System",
       size = "# Bills") +
  scale_fill_discrete(name = "Selection System") 

# ggsave("bills by state and selection.jpeg")
```


Bills by selection system

```{r}
gavel %>%
  group_by(State, Elected) %>%
  count() %>%
  ungroup() %>%
  group_by(Elected) %>%
  summarize(mean_bills = mean(n)) %>%
  ggplot(aes(x = Elected, y = mean_bills)) +
  geom_col() +
  labs(x = "Selection System", y = "Average Number of Bills")

ggsave("number of bills by selection system.jpeg")

gavel %>%
  group_by(State, Elected, Year) %>%
  count() %>%
  ungroup() %>%
  ggplot(aes(x = n, color = Elected)) +
  geom_density() +
  labs(x = "Number of Bills in a Year", y = "Density", color = "Selection System")

ggsave("Density of Bills.jpeg")
```

```{r}
gavel %>%
  mutate(RichardLastAction = ifelse(RichardLastAction == "introduced", "Introduced", 
                                    RichardLastAction)) %>%
  count(RichardLastAction) %>%
  filter(!is.na(RichardLastAction)) %>%
  mutate(RichardLastAction = fct_reorder(RichardLastAction, n)) %>%
  ggplot(aes(x = RichardLastAction, y = n, label = n)) +
  geom_col() +
  geom_text(hjust = -0.5) +
  labs(x = "Final Action", y = "Number of Bills") +
  ylim(0,7500) +
  coord_flip() 

# ggsave("Bills by Last Action.jpeg")
```


# Text Analysis


## Unnesting the tokens
```{r}
tidy_text <- gavel %>%
  unnest_tokens(word, Description) %>%
  anti_join(stop_words)
```

```{r}
tidy_text %>%
  count(word, sort = TRUE)
```

```{r}
tidy_text %>%
  group_by(curbing, Type) %>%
  count(word, sort = TRUE) %>%
  filter(n > 75) %>%
  filter(curbing == 1) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = Type)) +
  geom_col() +
  xlab(NULL) +
  facet_wrap(~ Type, scales = "free_y") +
  coord_flip() 
```

```{r}
sentiments_bing_gavel <- tidy_text %>%
  inner_join(get_sentiments("bing"))
```

## Figuring out the incorrectly classified

I noticed that words like "Supreme" are getting classified as positive, when that is not really what should be going on.
```{r}
# word_bing <- sentiments_bing_gavel %>%
#   count(word, sentiment, sort = TRUE)

# write_csv(word_bing, "bing words.csv", na = "")
```


```{r}
# word_afinn <- sentiments_afinn_gavel %>%
#   count(word, score, sort = TRUE)

# write_csv(word_afinn, "afinn words.csv", na = "")
```

```{r}
# word_nrc <- tidy_text %>%
#   inner_join(get_sentiments("nrc"), by = "word") %>%
#   anti_join(stop_words) %>%
#   count(word, sentiment, sort = TRUE)

# write_csv(word_nrc, "nrc words.csv", na = "")
```

## Evaluating potential conflict words

NOTE: if labeled as "2", then it needs greater inspection

```{r}
custom_afinn <- read_csv("afinn words.csv")
custom_bing <- read_csv("bing words.csv")
custom_nrc  <- read_csv("nrc words.csv")
```

```{r}
custom_afinn1 <- custom_afinn %>%
  filter(!is.na(`Stop words`), `Stop words` == 1) %>%
  select(word)

custom_bing1 <- custom_bing %>%
  filter(!is.na(`Custom Stop`), `Custom Stop` == 1) %>%
  select(word)

custom_nrc1 <- custom_nrc %>%
  filter(!is.na(`Stop words`), `Stop words` == 1) %>%
  select(word)

custom_afinn_stop_words <- stop_words %>%
  select(word) %>%
  rbind(custom_afinn1)

custom_bing_stop_words <- stop_words %>%
  select(word) %>%
  rbind(custom_bing1)

custom_nrc_stop_words <- stop_words %>%
  select(word) %>%
  rbind(custom_nrc1)
```


```{r}
tidy_afinn_custom_stop <- tidy_text %>%
  anti_join(custom_afinn_stop_words, by = "word") %>%
  inner_join(get_sentiments("afinn"))
```

```{r}
tidy_bing_custom_stop <- tidy_text %>%
  anti_join(custom_bing_stop_words, by = "word") %>%
  inner_join(get_sentiments("bing"))
```


```{r}
tidy_nrc_custom_stop <- tidy_text %>%
  anti_join(custom_nrc_stop_words, by = "word") %>%
  inner_join(get_sentiments("nrc"))
```


### Custom stop words datasets

Most common words in curbing legislation for afinn
```{r}
tidy_afinn_custom_stop %>%
  filter(curbing == 1) %>%
  count(word) %>%
  ungroup() %>%  
  filter(n > 10) %>%
  arrange(n) %>%
  mutate(word = factor(word, levels = unique(word))) %>%
  ggplot(aes(word, n)) +
  geom_col() +
  labs(x = "", y = "Word Counts") +
  coord_flip()
```


```{r}
t_words <- tidy_afinn_custom_stop %>%
  count(score, Year, Elected) %>%
  mutate(weighted_score = score * n) %>%
  group_by(Year, Elected) %>%
  summarize(all_words = sum(n))


tidy_afinn_custom_stop %>%
  count(score, Year, Elected) %>%
  mutate(weighted_score = score * n) %>% 
  spread(score, n, fill = 0) %>%
  select(Year, Elected, weighted_score) %>%
  group_by(Year, Elected) %>%
  summarize(total_score = sum(weighted_score)) %>%
  left_join(t_words, by = c("Year", "Elected")) %>%
  mutate(proportion_score = total_score / all_words) %>%
  ggplot(aes(x = Year, y = proportion_score, fill = total_score > 0)) +
  geom_col() +
  facet_wrap(~Elected)
```

```{r}
tidy_afinn_custom_stop %>%
  count(Elected, word) %>%
  bind_tf_idf(word, Elected, n) %>%
  arrange(desc(tf_idf)) %>%
  group_by(Elected) %>%
  top_n(20, tf_idf) %>%
  ungroup() %>%
  mutate(word = reorder(word, tf_idf)) %>%
  ggplot(aes(x = word, y = tf_idf, fill = Elected)) +
  geom_col() +
  facet_wrap(~Elected, scales = "free_y") +
  coord_flip() +
  labs(title = "All Bills")

tidy_afinn_custom_stop %>%
  filter(curbing == 1) %>%
  count(Elected, word) %>%
  bind_tf_idf(word, Elected, n) %>%
  arrange(desc(tf_idf)) %>%
  group_by(Elected) %>%
  filter(tf_idf > 0.0025) %>%
  ungroup() %>%
  mutate(word = reorder(word, tf_idf)) %>%
  ggplot(aes(x = word, y = tf_idf, fill = Elected)) +
  geom_col() +
  facet_wrap(~Elected, scales = "free") +
  coord_flip() +
  labs(title = "Curbing Legislation only")
```



## What about bigrams?

```{r}
filtered_bigrams <- gavel %>%
  unnest_tokens(bigram, Description, token = "ngrams", n = 2) %>%
  separate(bigram, c("word1", "word2"), sep = " ") %>%
  filter(!word1 %in% custom_afinn_stop_words$word) %>%
  filter(!word2 %in% custom_afinn_stop_words$word) %>%
  unite(bigram, word1, word2, sep = " ")
```


```{r}
filtered_bigrams %>%
  count(Elected, bigram) %>%
  bind_tf_idf(bigram, Elected, n) %>%
  arrange(desc(tf_idf)) %>%
  group_by(Elected) %>%
  top_n(20, tf_idf) %>%
  ungroup() %>%
  mutate(bigram = reorder(bigram, tf_idf)) %>%
  ggplot(aes(x = bigram, y = tf_idf, fill = Elected)) +
  geom_col() +
  facet_wrap(~Elected, scales = "free_y") +
  coord_flip() +
  labs(title = "All Bills")

filtered_bigrams %>%
  filter(curbing == 1) %>%
  count(Elected, bigram) %>%
  bind_tf_idf(bigram, Elected, n) %>%
  arrange(desc(tf_idf)) %>%
  group_by(Elected) %>%
  top_n(20, tf_idf) %>%
  ungroup() %>%
  mutate(bigram = reorder(bigram, tf_idf)) %>%
  ggplot(aes(x = bigram, y = tf_idf, fill = Elected)) +
  geom_col() +
  facet_wrap(~Elected, scales = "free_y") +
  coord_flip() +
  labs(title = "Curbing Legislation")
```


### Sentiment Analysis of Bigrams


```{r}
filtered_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ") %>%
  inner_join(get_sentiments("bing"), by = c("word1" = "word")) %>%
  unite("bigram", c(word1, word2), sep = " ") %>%
  rename(sentiment_word1 = "sentiment") %>%
  group_by(Elected, Year) %>%
  count(sentiment_word1) %>%
  spread(sentiment_word1, n) %>%
  mutate(negative = ifelse(is.na(negative), 0, negative), 
         net_sentiment = (positive - negative)/(negative + positive)) %>%
  filter(Year != 2007) %>%
  ggplot(aes(x = Year, y = net_sentiment, color = Elected)) +
  geom_line() +
  scale_x_continuous(breaks = c(2008, 2010, 2012, 2014, 2016)) +
  labs(title = "Sentiment of First Word")
```

```{r}
filtered_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ") %>%
  inner_join(get_sentiments("bing"), by = c("word2" = "word")) %>%
  unite("bigram", c(word1, word2), sep = " ") %>%
  rename(sentiment_word2 = "sentiment") %>%
  group_by(Elected, Year) %>%
  count(sentiment_word2) %>%
  spread(sentiment_word2, n) %>%
  mutate(negative = ifelse(is.na(negative), 0, negative), 
         net_sentiment = (positive - negative)/(negative + positive)) %>%
  filter(Year != 2007) %>%
  ggplot(aes(x = Year, y = net_sentiment, color = Elected)) +
  geom_line() +
  scale_x_continuous(breaks = c(2008, 2010, 2012, 2014, 2016)) +  
  labs(title = "Sentiment of Second Word")
```

```{r}
filtered_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ") %>%
  filter(!(word1 %in% c("supreme", "merit", "partisan"))) %>%
  filter(curbing == 1) %>%
  inner_join(get_sentiments("bing"), by = c("word1" = "word")) %>%
  unite("bigram", c(word1, word2), sep = " ") %>%
  rename(sentiment_word1 = "sentiment") %>%
  count(bigram, sentiment_word1, Elected) %>%
  group_by(sentiment_word1, Elected) %>%
  filter(n > 2) %>%
  ggplot(aes(x = bigram, y = n, fill = sentiment_word1)) +
  geom_col() +
  coord_flip() +
  facet_wrap(Elected~sentiment_word1, scales = "free") +
  labs(title = "Most Common Positive and Negative Words in Curbing Legislation \nof First Word")
```


There is still SOOOO much processing that needs to happen.. These legal words are so messy.  This last graph is better, but it still needs work.  This should really be up above.


## Network plots


```{r}
library(widyr)
library(igraph)
library(ggraph)

set.seed(051319)


bigrams_count <- filtered_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ") %>%
  count(word1, word2, sort = TRUE)



bigrams_count %>%
  filter(n > 100) %>%
  graph_from_data_frame() %>%
  ggraph(layout = "fr") +
  geom_edge_link() +
  geom_node_point() +
  geom_node_text(aes(label = name), vjust = 1, hjust = 1)

```





## ACTUALLY SUPPORTIVE GRAPHS

Below are weighted totals (weighted by the prevelance of the relevant variables).  Generally, the hope is to find that elected courts are almost always discussed more negatively than appointed.

Using bing dictionary, how are elected courts discussed?
```{r}
tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  count(sentiment, Year, Elected, word) %>%
  mutate(sentiment = ifelse(sentiment == "negative", -1, 1),
         net_sentiment = sentiment * n) %>%
  add_count(Year, Elected) %>%
  group_by(Year, Elected) %>%
  mutate(proportional_sentiment = net_sentiment / n) %>%
  summarize(total_score = sum(proportional_sentiment)) %>%
  ggplot(aes(x = Year, y = total_score, color = Elected)) +
  geom_line() +
  scale_x_continuous(breaks = c(2008, 2010, 2012, 2014, 2016)) +
  labs(y = "Net Sentiment", caption = "Using Bing Dictionary", color = "Selection System")

# ggsave("Net sentiment by selection.jpeg")
```

What about selection system AND ideologically distant?
```{r}
tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  count(sentiment, Year, outside, Elected, word) %>%
  mutate(sentiment = ifelse(sentiment == "negative", -1, 1),
         net_sentiment = sentiment * n) %>%
  add_count(Year, outside, Elected) %>%
  group_by(Year, outside, Elected) %>%
  mutate(proportional_sentiment = net_sentiment / n) %>%
  summarize(total_score = sum(proportional_sentiment)) %>%
  ggplot(aes(x = Year, y = total_score, color = Elected, lty = as.factor(outside))) +
  geom_line() +
  scale_x_continuous(breaks = c(2008, 2010, 2012, 2014, 2016)) +
  labs(y = "Net Sentiment", lty = "Ideologically Distant?", caption = "Using Bing Dictionary")
  
tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  count(sentiment, Year, outside, Elected, word) %>%
  mutate(sentiment = ifelse(sentiment == "negative", -1, 1),
         net_sentiment = sentiment * n) %>%
  add_count(Year, outside, Elected) %>%
  group_by(Year, outside, Elected) %>%
  mutate(proportional_sentiment = net_sentiment / n) %>%
  ungroup() %>%
  mutate(outside = ifelse(outside == 1, "Yes", "No")) %>%
  group_by(Year, outside, Elected) %>%
  summarize(total_score = sum(proportional_sentiment)) %>%
  ggplot(aes(x = Year, y = total_score, color = Elected)) +
  geom_line() +
  scale_x_continuous(breaks = c(2008, 2010, 2012, 2014, 2016)) +
  labs(y = "Net Sentiment", color = "Selection System", caption = "Using Bing Dictionary") +
  facet_wrap(~outside)

# ggsave("net sentiment by ideology and selection.jpeg")
```

```{r}
tidy_bing_custom_stop %>%
  count(sentiment, Type, word) %>%
  mutate(sentiment = ifelse(sentiment == "negative", -1, 1),
         net_sentiment = sentiment * n) %>%
  add_count(Type) %>%
  group_by(Type) %>%
  mutate(proportional_sentiment = net_sentiment / n) %>%
  summarize(total_score = sum(proportional_sentiment)) %>%
  mutate(Type = fct_reorder(Type, total_score)) %>%
  ggplot(aes(x = Type, y = total_score)) +
  geom_col() +
  labs(x = "Bill Type", y = "Net Sentiment", caption = "Using Bing Dictionary") +
  coord_flip()

# ggsave("sentiment by bill type.jpeg")
```

Sentiment by Bill type.  Takeaway: in every time, the elected is more negative than the appointed.
```{r}
tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  count(sentiment, Type, word, Elected) %>%
  mutate(sentiment = ifelse(sentiment == "negative", -1, 1),
         net_sentiment = sentiment * n) %>%
  add_count(Type, Elected) %>%
  group_by(Type, Elected) %>%
  mutate(proportional_sentiment = net_sentiment / n) %>%
  summarize(total_score = sum(proportional_sentiment)) %>%
  ungroup() %>%
  mutate(Type = fct_reorder(Type, total_score)) %>%
  ggplot(aes(x = Type, y = total_score, fill = Elected)) +
  geom_col(position = "dodge") +
  coord_flip()

# ggsave("sentiment by type and selection.jpeg")
```




Next is to do the same graphs but curbing, then start the write up

```{r}
tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  count(sentiment, curbing, word) %>%
  mutate(sentiment = ifelse(sentiment == "negative", -1, 1),
         net_sentiment = sentiment * n) %>%
  add_count(curbing) %>%
  group_by(curbing) %>%
  mutate(proportional_sentiment = net_sentiment / n) %>%
  summarize(total_score = sum(proportional_sentiment)) %>%
  ungroup() %>%
  filter(!is.na(curbing)) %>%
  ggplot(aes(x = as.factor(curbing), y = total_score, fill = as.factor(curbing))) +
  geom_col() +
  coord_cartesian(ylim = c(-2, 2)) +
  labs(fill = "court curbing")
```


```{r}
tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  count(sentiment, curbing, word, Elected) %>%
  mutate(sentiment = ifelse(sentiment == "negative", -1, 1),
         net_sentiment = sentiment * n) %>%
  add_count(curbing, Elected) %>%
  group_by(curbing, Elected) %>%
  mutate(proportional_sentiment = net_sentiment / n) %>%
  summarize(total_score = sum(proportional_sentiment)) %>%
  ungroup() %>%
  filter(!is.na(curbing)) %>%
  ggplot(aes(x = Elected, y = total_score, fill = as.factor(curbing))) +
  geom_col(position = "dodge") +
  coord_cartesian(ylim = c(-2, 2)) +
  labs(fill = "Court Curbing")
```


```{r}
tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  filter(sentiment == "positive") %>%
  unite(id, c("State", "Bill Number", "Year"), sep = " ") %>%
  pairwise_count(word, id, sort = TRUE) %>%
  filter(n > 3) %>%
  graph_from_data_frame() %>%
  ggraph(layout = "fr") +
  geom_edge_link() +
  geom_node_point() +
  geom_node_text(aes(label = name), vjust = 1, hjust = 1)
```


```{r}
tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  filter(sentiment == "negative") %>%
  unite(id, c("State", "Bill Number", "Year"), sep = " ") %>%
  pairwise_count(word, id, sort = TRUE) %>%
  filter(n > 5) %>%
  graph_from_data_frame() %>%
  ggraph(layout = "fr") +
  geom_edge_link() +
  geom_node_point() +
  geom_node_text(aes(label = name), vjust = 1, hjust = 1) +
  theme_void()
```


```{r}
tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  count(sentiment, Year, Elected, word, State) %>%
  mutate(sentiment = ifelse(sentiment == "negative", -1, 1),
         net_sentiment = sentiment * n) %>%
  add_count(Year, Elected) %>%
  group_by(Year, Elected, State) %>%
  mutate(proportional_sentiment = net_sentiment / n) %>%
  summarize(total_score = sum(proportional_sentiment)) %>%
  ggplot(aes(x = Year, y = total_score, color = Elected)) +
  geom_line() +
  scale_x_continuous(breaks = c(2008, 2010, 2012, 2014, 2016)) +
  labs(y = "Net Sentiment", caption = "Using Bing Dictionary", color = "Selection System")

tidy_bing_custom_stop %>%
  filter(word != "crime") %>%
  count(sentiment, Year, Elected, word, State) %>%
  mutate(sentiment = ifelse(sentiment == "negative", -1, 1),
         net_sentiment = sentiment * n) %>%
  add_count(Year, Elected) %>%
  group_by(Year, Elected, State) %>%
  mutate(proportional_sentiment = net_sentiment / n) %>%
  summarize(total_score = sum(proportional_sentiment)) %>%
  statebins_continuous(state_col = "State",
                     text_color = "white", value_col = "total_score",
                     brewer_pal="Reds", font_size = 3,
                     legend_title="Test")
```


Change colors in statebins
